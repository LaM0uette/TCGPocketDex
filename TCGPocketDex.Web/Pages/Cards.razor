@page "/cards"
@using TCGPocketDex.SDK.Cards
@using TCGPocketDex.SDK.References
@using TCGPocketDex.Contracts.Cards
@using TCGPocketDex.Contracts.References
@inject ICardsClient CardsClient
@inject ITypesClient TypesClient
@inject IStagesClient StagesClient
@inject IAbilitiesClient AbilitiesClient
@inject IAttacksClient AttacksClient
@inject ICardExtensionsClient CardExtensionsClient
@inject IBoostersClient BoostersClient
@inject IRaritiesClient RaritiesClient
@inject IPromoSeriesClient PromoSeriesClient

<h1>Cards</h1>

<div>
    <label>Culture: <input @bind="culture" /></label>
    <button @onclick="Load">Load</button>
</div>

@if (cardsDisplay is null)
{
    <p>Loading...</p>
}
else if (cardsDisplay.Count == 0)
{
    <p>No cards.</p>
}
else
{
    <ul>
        @foreach (var row in cardsDisplay)
        {
            <li>@row.Id - EN: @row.NameEn | FR: @row.NameFr | ImageUrl: @row.ImageUrl</li>
        }
    </ul>
}

<hr />
<button @onclick="ToggleNew">@((showNew ? "Cancel" : "New"))</button>
@if (showNew)
{
    <EditForm Model="edit" OnValidSubmit="Create">
        <DataAnnotationsValidator />
        <fieldset>
            <legend>Localizations</legend>
            <div>
                <label>Name (EN): <input @bind="edit.NameEn" /></label>
            </div>
            <div>
                <label>Description (EN): <textarea @bind="edit.DescriptionEn"></textarea></label>
            </div>
            <div>
                <label>Name (FR): <input @bind="edit.NameFr" /></label>
            </div>
        </fieldset>
        <div>
            <label>ImageUrl: <input @bind="edit.ImageUrl" /></label>
        </div>
        <div>
            <label>Rarity:
                <select @bind="edit.CardRarityId">
                    <option value="">-- select --</option>
                    @foreach (var r in rarities)
                    {
                        <option value="@r.Id">@r.Name</option>
                    }
                </select>
            </label>
        </div>
        <div>
            <label>Kind:
                <select @bind="edit.Kind">
                    @foreach (var k in Enum.GetValues<CardKind>())
                    {
                        <option value="@k">@k</option>
                    }
                </select>
            </label>
        </div>
        <fieldset>
            <legend>Origin</legend>
            <label><input type="radio" name="origin" value="booster" @onchange="_ => SetOrigin(true)" checked="@useBooster" /> Booster</label>
            <label><input type="radio" name="origin" value="promo" @onchange="_ => SetOrigin(false)" checked="@(!useBooster)" /> Promo</label>
            @if (useBooster)
            {
                <div>
                    <label>Extension:
                        <select @bind="edit.CardExtensionId" @bind:after="OnExtensionChanged">
                            <option value="">-- select --</option>
                            @foreach (var e in extensions)
                            {
                                <option value="@e.Id">@e.Series - @e.Code - @e.Name</option>
                            }
                        </select>
                    </label>
                </div>
                <div>
                    <label>Booster:
                        <select @bind="edit.BoosterId">
                            <option value="">-- select --</option>
                            @foreach (var b in boosters)
                            {
                                <option value="@b.Id">@b.Name</option>
                            }
                        </select>
                    </label>
                </div>
            }
            else
            {
                <div>
                    <label>Promo Series:
                        <select @bind="edit.PromoSeriesId">
                            <option value="">-- select --</option>
                            @foreach (var p in promoSeries)
                            {
                                <option value="@p.Id">@p.Code - @p.Name</option>
                            }
                        </select>
                    </label>
                </div>
            }
        </fieldset>
        <div>
            <label>ExtensionCardNumber: <input type="number" @bind="edit.ExtensionCardNumber" /></label>
        </div>

        @if (edit.Kind == CardKind.Fossil)
        {
            <div>
                <label>Fossil HP: <input type="number" @bind="edit.FossilHp" /></label>
            </div>
        }
        else if (edit.Kind == CardKind.Pokemon)
        {
            <div>
                <label>Is EX: <input type="checkbox" @bind="edit.PokemonIsEx" /></label>
            </div>
            <div>
                <label>Is Mega: <input type="checkbox" @bind="edit.PokemonIsMega" /></label>
            </div>
            <div>
                <label>Stage:
                    <select @bind="edit.PokemonStageId">
                        <option value="">-- select --</option>
                        @foreach (var s in stages)
                        {
                            <option value="@s.Id">@s.Name</option>
                        }
                    </select>
                </label>
            </div>
            <div>
                <label>HP: <input type="number" @bind="edit.PokemonHp" /></label>
            </div>
            <div>
                <label>Type:
                    <select @bind="edit.PokemonTypeId">
                        <option value="">-- select --</option>
                        @foreach (var t in types)
                        {
                            <option value="@t.Id">@t.Name</option>
                        }
                    </select>
                </label>
            </div>
            <div>
                <label>Weakness:
                    <select @bind="edit.PokemonWeaknessTypeId">
                        <option value="">-- none --</option>
                        @foreach (var t in types)
                        {
                            <option value="@t.Id">@t.Name</option>
                        }
                    </select>
                </label>
            </div>
            <div>
                <label>Retreat Cost: <input type="number" @bind="edit.PokemonRetreatCost" /></label>
            </div>
            <div>
                <label>Ability:
                    <select @bind="edit.PokemonAbilityId">
                        <option value="">-- none --</option>
                        @foreach (var a in abilities)
                        {
                            <option value="@a.Id">@a.Name</option>
                        }
                    </select>
                </label>
            </div>
            <div>
                <label>Add Attack:
                    <select @bind="selectedAttackToAdd">
                        <option value="">-- select --</option>
                        @foreach (var a in attacks)
                        {
                            <option value="@a.Id">@a.Name (@a.Damage)</option>
                        }
                    </select>
                    <button type="button" @onclick="AddSelectedAttack" disabled="@(!selectedAttackToAdd.HasValue)">Add</button>
                </label>
            </div>
            <div>
                <strong>Selected Attacks:</strong>
                <ul>
                    @foreach (var id in selectedAttackIds)
                    {
                        var a = attacks.FirstOrDefault(x => x.Id == id);
                        <li>@a?.Name (@a?.Damage) <button type="button" @onclick="() => RemoveAttack(id)">Remove</button></li>
                    }
                </ul>
            </div>
        }

        <button type="submit">Create</button>
    </EditForm>
}

@code {
    private string culture = "fr";
    private List<CardOutputDTO> cards = new();
    private List<CardListRow> cardsDisplay = new();

    private sealed class CardListRow
    {
        public int Id { get; set; }
        public string? NameEn { get; set; }
        public string? NameFr { get; set; }
        public string ImageUrl { get; set; } = string.Empty;
    }
    private bool showNew = false;
    private bool useBooster = true;
    private string? attackIdsRaw;

    private List<PokemonTypeOutputDTO> types = new();
    private List<PokemonStageOutputDTO> stages = new();

    private List<CardRarityOutputDTO> rarities = new();
    private List<CardExtensionOutputDTO> extensions = new();
    private List<BoosterOutputDTO> boosters = new();
    private List<PokemonAbilityOutputDTO> abilities = new();
    private List<PokemonAttackOutputDTO> attacks = new();
    private List<PromoSeriesOutputDTO> promoSeries = new();

    private bool showNewType = false;
    private bool showNewStage = false;

    private bool showNewRarity = false;
    private bool showNewExtension = false;
    private bool showNewBooster = false;
    private bool showNewAbility = false;
    private bool showNewAttack = false;
    private bool showNewPromoSeries = false;

    private string? newTypeName;
    private string? newTypeImageUrl;
    private string? newStageName;

    private string? newRarityName;
    private string? newRarityImageUrl;

    private string? newExtensionSeries;
    private string? newExtensionCode;
    private string? newExtensionName;

    private string? newBoosterName;

    private string? newAbilityName;

    private string? newPromoSeriesCode;
    private string? newPromoSeriesName;

    private string? newAttackName;
    private string? newAttackDescription;
    private int newAttackDamage;
    private HashSet<int> newAttackCostTypeIds = new();

    private HashSet<int> selectedAttackIds = new();
    private int? selectedAttackToAdd;

    private NewCardModel edit = new()
    {
        CardRarityId = 1,
        Kind = CardKind.Item
    };

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        types = (await TypesClient.GetAllAsync(culture)).ToList();
        stages = (await StagesClient.GetAllAsync(culture)).ToList();
        rarities = (await RaritiesClient.GetAllAsync()).ToList();
        extensions = (await CardExtensionsClient.GetAllAsync(culture)).ToList();
        abilities = (await AbilitiesClient.GetAllAsync(culture)).ToList();
        attacks = (await AttacksClient.GetAllAsync(culture)).ToList();
        promoSeries = (await PromoSeriesClient.GetAllAsync(culture)).ToList();
        await LoadBoostersForSelectedExtension();

        // Load cards for EN and FR to display both names and image URL
        var listEn = (await CardsClient.GetAllAsync("en")).ToList();
        var listFr = (await CardsClient.GetAllAsync("fr")).ToList();
        var dictEn = listEn.ToDictionary(x => x.Id, x => x);
        var dictFr = listFr.ToDictionary(x => x.Id, x => x);
        var allIds = dictEn.Keys.Union(dictFr.Keys).OrderBy(id => id);
        cardsDisplay = new List<CardListRow>();
        foreach (var id in allIds)
        {
            dictEn.TryGetValue(id, out var en);
            dictFr.TryGetValue(id, out var fr);
            cardsDisplay.Add(new CardListRow
            {
                Id = id,
                NameEn = en?.Name,
                NameFr = fr?.Name,
                ImageUrl = en?.ImageUrl ?? fr?.ImageUrl ?? string.Empty
            });
        }

        // Keep culture-specific list if needed elsewhere
        cards = (await CardsClient.GetAllAsync(culture)).ToList();
        StateHasChanged();
    }

    private void ToggleNew()
    {
        showNew = !showNew;
    }

    private void SetOrigin(bool booster)
    {
        useBooster = booster;
        if (booster)
        {
            edit.PromoSeriesId = null;
        }
        else
        {
            edit.BoosterId = null;
            edit.CardExtensionId = null;
        }
    }

    private void ParseAttacks()
    {
        if (string.IsNullOrWhiteSpace(attackIdsRaw))
        {
            edit.PokemonAttackIds = null;
            return;
        }
        var ids = attackIdsRaw.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
            .Select(s => int.TryParse(s, out var v) ? v : (int?)null)
            .Where(v => v.HasValue)
            .Select(v => v!.Value)
            .ToList();
        edit.PokemonAttackIds = ids;
    }

    private void ToggleNewType() => showNewType = !showNewType;
    private void ToggleNewStage() => showNewStage = !showNewStage;

    private async Task CreateType()
    {
        if (string.IsNullOrWhiteSpace(newTypeName) || string.IsNullOrWhiteSpace(newTypeImageUrl)) return;
        var dto = new PokemonTypeInputDTO(culture, newTypeName, newTypeImageUrl);
        var created = await TypesClient.CreateAsync(dto);
        if (created != null)
        {
            types.Add(created);
            edit.PokemonTypeId = created.Id;
            if (!edit.PokemonWeaknessTypeId.HasValue) edit.PokemonWeaknessTypeId = created.Id;
            showNewType = false;
            newTypeName = null;
            newTypeImageUrl = null;
            StateHasChanged();
        }
    }

    private async Task CreateStage()
    {
        if (string.IsNullOrWhiteSpace(newStageName)) return;
        var dto = new PokemonStageInputDTO(culture, newStageName);
        var created = await StagesClient.CreateAsync(dto);
        if (created != null)
        {
            stages.Add(created);
            edit.PokemonStageId = created.Id;
            showNewStage = false;
            newStageName = null;
            StateHasChanged();
        }
    }

    private void ToggleNewRarity() => showNewRarity = !showNewRarity;
    private void ToggleNewExtension() => showNewExtension = !showNewExtension;
    private void ToggleNewBooster() => showNewBooster = !showNewBooster;
    private void ToggleNewAbility() => showNewAbility = !showNewAbility;
    private void ToggleNewAttack() => showNewAttack = !showNewAttack;
    private void ToggleNewPromoSeries() => showNewPromoSeries = !showNewPromoSeries;

    private async Task CreateRarity()
    {
        if (string.IsNullOrWhiteSpace(newRarityName) || string.IsNullOrWhiteSpace(newRarityImageUrl)) return;
        var dto = new CardRarityInputDTO(newRarityName, newRarityImageUrl);
        var created = await RaritiesClient.CreateAsync(dto);
        if (created != null)
        {
            rarities.Add(created);
            edit.CardRarityId = created.Id;
            showNewRarity = false;
            newRarityName = null;
            newRarityImageUrl = null;
            StateHasChanged();
        }
    }

    private async Task OnExtensionChanged()
    {
        await LoadBoostersForSelectedExtension();
    }

    private async Task LoadBoostersForSelectedExtension()
    {
        if (edit.CardExtensionId.HasValue)
        {
            boosters = (await BoostersClient.GetAllAsync(culture, edit.CardExtensionId.Value)).ToList();
            if (!edit.BoosterId.HasValue || !boosters.Any(b => b.Id == edit.BoosterId.Value)) edit.BoosterId = null;
        }
        else
        {
            boosters = new List<BoosterOutputDTO>();
            edit.BoosterId = null;
        }
    }

    private async Task CreateExtension()
    {
        if (string.IsNullOrWhiteSpace(newExtensionSeries) || string.IsNullOrWhiteSpace(newExtensionCode) || string.IsNullOrWhiteSpace(newExtensionName)) return;
        var dto = new CardExtensionInputDTO(newExtensionSeries, newExtensionCode, culture, newExtensionName, null);
        var created = await CardExtensionsClient.CreateAsync(dto);
        if (created != null)
        {
            extensions.Add(created);
            edit.CardExtensionId = created.Id;
            showNewExtension = false;
            newExtensionSeries = null;
            newExtensionCode = null;
            newExtensionName = null;
            await LoadBoostersForSelectedExtension();
            StateHasChanged();
        }
    }

    private async Task CreateBooster()
    {
        if (!edit.CardExtensionId.HasValue || string.IsNullOrWhiteSpace(newBoosterName)) return;
        var dto = new BoosterInputDTO(edit.CardExtensionId.Value, culture, newBoosterName, null);
        var created = await BoostersClient.CreateAsync(dto);
        if (created != null)
        {
            boosters.Add(created);
            edit.BoosterId = created.Id;
            showNewBooster = false;
            newBoosterName = null;
            StateHasChanged();
        }
    }

    private async Task CreateAbility()
    {
        if (string.IsNullOrWhiteSpace(newAbilityName)) return;
        var dto = new PokemonAbilityInputDTO(culture, newAbilityName);
        var created = await AbilitiesClient.CreateAsync(dto);
        if (created != null)
        {
            abilities.Add(created);
            edit.PokemonAbilityId = created.Id;
            showNewAbility = false;
            newAbilityName = null;
            StateHasChanged();
        }
    }

    private async Task CreatePromoSeries()
    {
        if (string.IsNullOrWhiteSpace(newPromoSeriesCode) || string.IsNullOrWhiteSpace(newPromoSeriesName)) return;
        var dto = new PromoSeriesInputDTO(newPromoSeriesCode!, culture, newPromoSeriesName!);
        var created = await PromoSeriesClient.CreateAsync(dto);
        if (created != null)
        {
            promoSeries.Add(created);
            edit.PromoSeriesId = created.Id;
            showNewPromoSeries = false;
            newPromoSeriesCode = null;
            newPromoSeriesName = null;
            StateHasChanged();
        }
    }

    private async Task CreateAttack()
    {
        if (string.IsNullOrWhiteSpace(newAttackName)) return;
        var dto = new PokemonAttackInputDTO(culture, newAttackName, newAttackDescription, newAttackDamage, newAttackCostTypeIds.ToList());
        var created = await AttacksClient.CreateAsync(dto);
        if (created != null)
        {
            attacks.Add(created);
            selectedAttackIds.Add(created.Id);
            showNewAttack = false;
            newAttackName = null;
            newAttackDescription = null;
            newAttackDamage = 0;
            newAttackCostTypeIds.Clear();
            StateHasChanged();
        }
    }

    private void AddSelectedAttack()
    {
        if (selectedAttackToAdd.HasValue)
        {
            selectedAttackIds.Add(selectedAttackToAdd.Value);
            selectedAttackToAdd = null;
        }
    }

    private void RemoveAttack(int id)
    {
        if (selectedAttackIds.Contains(id)) selectedAttackIds.Remove(id);
    }

    private void ToggleAttackCostType(int typeId, ChangeEventArgs e)
    {
        var isChecked = e.Value is bool b && b;
        if (isChecked) newAttackCostTypeIds.Add(typeId);
        else newAttackCostTypeIds.Remove(typeId);
    }

    private async Task Create()
    {
        try
        {
            if (useBooster)
            {
                if (!edit.BoosterId.HasValue || !edit.CardExtensionId.HasValue)
                {
                    return;
                }
                edit.PromoSeriesId = null;
            }
            else
            {
                if (!edit.PromoSeriesId.HasValue)
                {
                    return;
                }
                edit.BoosterId = null;
                edit.CardExtensionId = null;
            }

            edit.PokemonAttackIds = selectedAttackIds.Count > 0 ? selectedAttackIds.ToList() : null;

            // Create EN first
            var dtoEn = new CardInputDTO(
                Culture: "en",
                Name: edit.NameEn ?? string.Empty,
                Description: edit.DescriptionEn,
                ImageUrl: edit.ImageUrl ?? string.Empty,
                CardRarityId: edit.CardRarityId,
                BoosterId: edit.BoosterId,
                CardExtensionId: edit.CardExtensionId,
                ExtensionCardNumber: edit.ExtensionCardNumber,
                PromoSeriesId: edit.PromoSeriesId,
                Kind: edit.Kind,
                FossilHp: edit.FossilHp,
                PokemonIsEx: edit.PokemonIsEx,
                PokemonIsMega: edit.PokemonIsMega,
                PokemonStageId: edit.PokemonStageId,
                PokemonHp: edit.PokemonHp,
                PokemonTypeId: edit.PokemonTypeId,
                PokemonWeaknessTypeId: edit.PokemonWeaknessTypeId,
                PokemonRetreatCost: edit.PokemonRetreatCost,
                PokemonAbilityId: edit.PokemonAbilityId,
                PokemonAttackIds: edit.PokemonAttackIds
            );
            var createdEn = await CardsClient.CreateAsync(dtoEn);

            // Add FR translation (server copies EN ImageUrl if not provided)
            if (!string.IsNullOrWhiteSpace(edit.NameFr))
            {
                var dtoFr = new CardTranslationInputDTO(
                    Culture: "fr",
                    Name: edit.NameFr ?? string.Empty,
                    Description: null,
                    ImageUrl: null
                );
                await CardsClient.AddTranslationAsync(createdEn.Id, dtoFr);
            }

            // Keep the form open for mass creation; just reload the list
            await Load();
        }
        catch (Exception)
        {
        }
    }

    private class NewCardModel
    {
        // Localizations
        public string? NameEn { get; set; }
        public string? DescriptionEn { get; set; }
        public string? NameFr { get; set; }

        // Shared fields
        public string? ImageUrl { get; set; }
        public int CardRarityId { get; set; }
        public int? BoosterId { get; set; }
        public int? CardExtensionId { get; set; }
        public int? ExtensionCardNumber { get; set; }
        public int? PromoSeriesId { get; set; }
        public CardKind Kind { get; set; }
        public int? FossilHp { get; set; }
        public bool? PokemonIsEx { get; set; }
        public bool? PokemonIsMega { get; set; }
        public int? PokemonStageId { get; set; }
        public int? PokemonHp { get; set; }
        public int? PokemonTypeId { get; set; }
        public int? PokemonWeaknessTypeId { get; set; }
        public int? PokemonRetreatCost { get; set; }
        public int? PokemonAbilityId { get; set; }
        public IReadOnlyList<int>? PokemonAttackIds { get; set; }
    }
}
